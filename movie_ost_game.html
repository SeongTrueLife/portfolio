<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>영화 OST 퀴즈 (사운드 강화)</title>
    <!-- Tone.js CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap');

        :root {
            --bg-color: #1a1d24;
            --surface-color: #2c313a;
            --primary-color: #f5c518; /* IMDb 느낌의 노란색 */
            --text-color: #f0f0f0;
            --correct-color: #28a745;
            --wrong-color: #dc3545;
        }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }

        .game-container {
            background-color: var(--surface-color);
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            width: 100%;
            max-width: 600px;
            text-align: center;
        }

        .screen { display: none; }
        .screen.active { display: block; }

        h1, h2 {
            color: var(--primary-color);
            margin-top: 0;
        }

        p {
            font-size: 1.1rem;
            color: #ccc;
        }

        .btn {
            background-color: var(--primary-color);
            color: #121212;
            border: none;
            padding: 15px 30px;
            font-size: 1.2rem;
            font-weight: 700;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            margin-top: 1rem;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 15px rgba(245, 197, 24, 0.4);
        }

        /* 퀴즈 화면 스타일 */
        #quiz-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            font-size: 1.2rem;
        }
        
        #progress { font-weight: 700; }
        #score { color: var(--primary-color); }
        
        #play-melody-btn {
            font-size: 3rem;
            background: none;
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
            width: 100px;
            height: 100px;
            border-radius: 50%;
            margin-bottom: 2rem;
        }
        
        #play-melody-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            color: #777;
            border-color: #777;
        }

        #options-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .option-btn {
            background-color: #4a505a;
            color: var(--text-color);
            padding: 15px;
            font-size: 1rem;
            border-radius: 8px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .option-btn:hover:not([disabled]) {
            border-color: var(--primary-color);
        }

        .option-btn.correct {
            background-color: var(--correct-color);
            border-color: var(--correct-color);
        }

        .option-btn.wrong {
            background-color: var(--wrong-color);
            border-color: var(--wrong-color);
        }

        @media (max-width: 480px) {
            #options-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>

    <div class="game-container">
        <!-- 시작 화면 -->
        <div id="start-screen" class="screen active">
            <h1>영화 OST 퀴즈</h1>
            <p>매번 무작위로 10개의 문제가 출제됩니다. <br>재생 버튼을 누르고 어떤 영화의 OST인지 맞춰보세요!</p>
            <button id="start-btn" class="btn">게임 시작</button>
        </div>

        <!-- 퀴즈 진행 화면 -->
        <div id="quiz-screen" class="screen">
            <div id="quiz-header">
                <span id="progress"></span>
                <span id="score"></span>
            </div>
            <p>이 멜로디는 어떤 영화의 OST일까요?</p>
            <button id="play-melody-btn" class="btn">▶</button>
            <div id="options-container"></div>
        </div>

        <!-- 결과 화면 -->
        <div id="end-screen" class="screen">
            <h2>게임 종료!</h2>
            <p>당신의 최종 점수는...</p>
            <h1 id="final-score"></h1>
            <button id="restart-btn" class="btn">다시하기</button>
        </div>
    </div>

    <script>
        // --- 1. 전체 퀴즈 데이터 (BPM, 화음 등 개선) ---
        const allQuizData = [
            { // 1. 해리포터 (Celesta 느낌)
                bpm: 140,
                melody: [
                    { time: '0:0', note: 'B4', duration: '8n' }, { time: '0:0:2', note: 'E5', duration: '4n.' }, { time: '0:1:2', note: 'G5', duration: '8n' },
                    { time: '0:2', note: 'F#5', duration: '4n' }, { time: '0:3', note: 'E5', duration: '4n.' }, { time: '1:0:2', note: 'B5', duration: '8n' },
                    { time: '1:1', note: 'A5', duration: '4n' }, { time: '1:2', note: 'F#5', duration: '2n' },
                ],
                options: ["반지의 제왕", "해리포터", "나니아 연대기", "어벤져스"],
                answer: "해리포터",
            },
            { // 2. 스타워즈 (웅장한 화음)
                bpm: 110,
                melody: [
                    { time: '0:0', note: ['G4', 'D4'], duration: '8n' }, { time: '0:0:2', note: ['G4', 'D4'], duration: '8n' }, { time: '0:1', note: ['G4', 'D4'], duration: '8n' },
                    { time: '0:2', note: ['C5', 'G4'], duration: '2n' }, { time: '1:0', note: ['G5', 'D5'], duration: '2n' },
                    { time: '1:2', note: 'F#5', duration: '4n' }, { time: '1:3', note: 'E5', duration: '4n' }, { time: '2:0', note: 'D#5', duration: '4n' },
                    { time: '2:1', note: ['C6', 'G5'], duration: '2n' }, { time: '2:3', note: ['G5', 'D5'], duration: '2n' },
                ],
                options: ["스타트렉", "인터스텔라", "스타워즈", "가디언즈 오브 갤럭시"],
                answer: "스타워즈",
            },
            { // 3. 쥬라기 공원 (부드러운 화음)
                bpm: 80,
                melody: [
                    { time: '0:0', note: ['G4','D4'], duration: '2n' }, { time: '0:2', note: ['A4','E4'], duration: '2n' }, 
                    { time: '1:0', note: ['B4','F#4'], duration: '2n' }, { time: '1:2', note: ['G4','D4'], duration: '2n' },
                    { time: '2:0', note: 'B4', duration: '4n.' }, { time: '2:1:2', note: 'A4', duration: '8n' }, { time: '2:2', note: 'G4', duration: '1n' },
                ],
                options: ["인디아나 존스", "E.T.", "킹콩", "쥬라기 공원"],
                answer: "쥬라기 공원",
            },
            { // 4. 라이온 킹
                bpm: 120,
                melody: [
                    { time: '0:0', note: "F4", duration: "4n" }, { time: '0:1', note: "A4", duration: "4n" }, { time: '0:2', note: "C5", duration: "2n" },
                    { time: '1:0', note: "C5", duration: "4n" }, { time: '1:1', note: "D5", duration: "4n" }, { time: '1:2', note: "C5", duration: "4n" }, { time: '1:3', note: "A4", duration: "4n" },
                    { time: '2:0', note: "F4", duration: "2n" },
                ],
                options: ["알라딘", "라이온 킹", "인어공주", "포카혼타스"],
                answer: "라이온 킹",
            },
            { // 5. 캐리비안의 해적 (빠른 템포)
                bpm: 140,
                melody: [
                    { time: '0:0', note: 'D4', duration: '8n' }, { time: '0:0:2', note: 'D4', duration: '8n' }, { time: '0:1', note: 'D4', duration: '8n' }, { time: '0:1:2', note: 'D4', duration: '8n' },
                    { time: '0:2', note: 'D4', duration: '8n' }, { time: '0:2:2', note: 'E4', duration: '8n' }, { time: '0:3', note: 'F4', duration: '4n' }, 
                    { time: '1:0', note: 'F4', duration: '4n' }, { time: '1:1', note: 'F4', duration: '8n' }, { time: '1:1:2', note: 'G4', duration: '8n' }, { time: '1:2', note: 'A4', duration: '4n' }, { time: '1:3', note: 'A4', duration: '4n' }
                ],
                options: ["캐리비안의 해적", "반지의 제왕", "글래디에이터", "킹덤 오브 헤븐"],
                answer: "캐리비안의 해적",
            },
            // --- 나머지 곡들은 간결하게 단일 멜로디와 BPM만 추가 ---
            { bpm: 90, melody: [{ time: '0:0', note: "G4", duration: "4n" }, { time: '0:1', note: "C5", duration: "4n." }, { time: '0:2:2', note: "D#5", duration: "8n" }], options: ["대부", "스카페이스", "좋은 친구들", "원스 어폰 어 타임 인 아메리카"], answer: "대부" },
            { bpm: 170, melody: [{ time: '0:0', note: "G5", duration: "8n" }, { time: '0:0:2', note: "G5", duration: "8n" }, { time: '0:1', note: "A#5", duration: "4n" }], options: ["007 시리즈", "본 시리즈", "미션 임파서블", "킹스맨"], answer: "미션 임파서블" },
            { bpm: 95, melody: [{ time: '0:0', note: "F4", duration: "8n" }, { time: '0:0:2', note: "G4", duration: "8n" }, { time: '0:1', note: "A4", duration: "4n" }, { time: '0:2', note: "G4", duration: "8n" }, { time: '0:2:2', note: "F4", duration: "8n" }, { time: '0:3', note: "G4", duration: "4n" }], options: ["라라랜드", "위대한 쇼맨", "비긴 어게인", "타이타닉"], answer: "타이타닉" },
            { bpm: 70, melody: [{ time: '0:0', note: "C4", duration: "4n" }, { time: '0:1', note: "G4", duration: "4n" }, { time: '0:2', note: "F#4", duration: "4n" }, { time: '0:3', note: "G4", duration: "4n" }], options: ["인터스텔라", "그래비티", "혹성탈출", "인셉션"], answer: "인터스텔라" },
            { bpm: 130, melody: [{ time: '0:0', note: "E4", duration: "8n" }, { time: '0:0:2', note: "G4", duration: "8n" }, { time: '0:1', note: "C5", duration: "4n" }, { time: '0:2', note: "E4", duration: "8n" }, { time: '0:2:2', note: "G4", duration: "8n" }, { time: '0:3', note: "B4", duration: "4n" }], options: ["어벤져스", "다크 나이트", "맨 오브 스틸", "스파이더맨"], answer: "어벤져스" },
            { bpm: 90, melody: [{ time: '0:0', note: "D5", duration: "4n" }, { time: '0:1', note: "A#4", duration: "4n" }, { time: '0:2', note: "G4", duration: "4n" }, { time: '0:3', note: "D4", duration: "4n" }], options: ["하울의 움직이는 성", "센과 치히로의 행방불명", "이웃집 토토로", "모노노케 히메"], answer: "하울의 움직이는 성" },
            { bpm: 100, melody: [{ time: '0:0', note: "G4", duration: "4n" }, { time: '0:1', note: "G4", duration: "4n" }, { time: '0:2', note: "A4", duration: "4n" }, { time: '0:3', note: "B4", duration: "4n" }], options: ["UP", "토이스토리", "겨울왕국", "모아나"], answer: "겨울왕국" },
            { bpm: 115, melody: [{ time: '0:0', note: "D4", duration: "4n" }, { time: '0:1', note: "G4", duration: "4n" }, { time: '0:2', note: "A4", duration: "4n" }, { time: '0:3', note: "B4", duration: "4n" }], options: ["백 투 더 퓨처", "고스트버스터즈", "E.T.", "터미네이터"], answer: "백 투 더 퓨처" },
            { bpm: 80, melody: [{ time: '0:0', note: "A4", duration: "4n" }, { time: '0:1', note: "A4", duration: "4n" }, { time: '0:2', note: "G4", duration: "4n" }, { time: '0:3', note: "A4", duration: "4n" }], options: ["포레스트 검프", "쇼생크 탈출", "인생은 아름다워", "시네마 천국"], answer: "시네마 천국" },
            { bpm: 160, melody: [{ time: '0:0', note: "A4", duration: "4n" }, { time: '0:1', note: "F4", duration: "4n" }, { time: '0:2', note: "A4", duration: "4n" }, { time: '0:3', note: "D5", duration: "2n" }], options: ["펄프 픽션", "킬빌", "저수지의 개들", "장고"], answer: "킬빌" },
            { bpm: 132, melody: [{ time: '0:0', note: "E4", duration: "4n" }, { time: '0:1', note: "D#4", duration: "4n" }, { time: '0:2', note: "E4", duration: "4n" }, { time: '0:3', note: "D#4", duration: "4n" }], options: ["제임스 본드", "미션 임파서블", "다이하드", "리썰 웨폰"], answer: "제임스 본드" },
            { bpm: 100, melody: [{ time: '0:0', note: "G4", duration: "4n" }, { time: '0:1', note: "C5", duration: "2n" }, { time: '0:3', note: "G4", duration: "4n" }], options: ["록키", "슈퍼맨", "배트맨", "원더우먼"], answer: "슈퍼맨" },
            { bpm: 75, melody: [{ time: '0:0', note: "C4", duration: "8n" }, { time: '0:0:2', note: "C4", duration: "8n" }, { time: '0:1', note: "C4", duration: "8n" }, { time: '0:1:2', note: "G4", duration: "4n." }], options: ["포레스트 검프", "라이언 일병 구하기", "캐스트 어웨이", "터미널"], answer: "포레스트 검프" },
            { bpm: 100, melody: [{ time: '0:0', note: "C4", duration: "4n" }, { time: '0:1', note: "C4", duration: "4n" }, { time: '0:2', note: "G4", duration: "4n" }, { time: '0:3', note: "G4", duration: "4n" }], options: ["학교 가는 길", "섬집 아기", "반짝 반짝 작은 별", "비행기"], answer: "반짝 반짝 작은 별" },
            { bpm: 90, melody: [{ time: '0:0', note: "G4", duration: "4n" }, { time: '0:1', note: "A4", duration: "4n" }, { time: '0:2', note: "G4", duration: "4n" }, { time: '0:3', note: "F4", duration: "4n" }], options: ["알라딘", "미녀와 야수", "뮬란", "노트르담의 꼽추"], answer: "미녀와 야수" },
            { bpm: 125, melody: [{ time: '0:0', note: "C5", duration: "4n" }, { time: '0:1', note: "A4", duration: "4n" }, { time: '0:2', note: "F4", duration: "4n" }, { time: '0:3', note: "C5", duration: "4n" }], options: ["라라랜드", "위플래쉬", "코코", "소울"], answer: "라라랜드" },
            { bpm: 72, melody: [{ time: '0:0', note: "D4", duration: "4n" }, { time: '0:1', note: "A4", duration: "4n" }, { time: '0:2', note: "G4", duration: "2n" }], options: ["쇼생크 탈출", "글래디에이터", "브레이브하트", "반지의 제왕"], answer: "반지의 제왕" },
            { bpm: 130, melody: [{ time: '0:0', note: "G4", duration: "4n" }, { time: '0:1', note: "F#4", duration: "4n" }, { time: '0:2', note: "G4", duration: "4n" }, { time: '0:3', note: "D4", duration: "4n" }], options: ["센과 치히로의 행방불명", "이웃집 토토로", "벼랑 위의 포뇨", "바람계곡의 나우시카"], answer: "이웃집 토토로" },
            { bpm: 130, melody: [{ time: '0:0', note: "D5", duration: "4n" }, { time: '0:1', note: "E5", duration: "4n" }, { time: '0:2', note: "C5", duration: "2n" }], options: ["오징어 게임", "기생충", "올드보이", "부산행"], answer: "기생충" },
            { bpm: 60, melody: [{ time: '0:0', note: ["A4", "E4", "C#4"], duration: "2n" }, { time: '0:2', note: ["F#4", "C#4", "A3"], duration: "2n" }], options: ["2001 스페이스 오디세이", "블레이드 러너", "시계태엽 오렌지", "샤이닝"], answer: "2001 스페이스 오디세이" }
        ];

        // --- 2. DOM 요소 & 오디오 객체 ---
        // (이 부분은 이전과 동일)
        const startScreen = document.getElementById('start-screen');
        const quizScreen = document.getElementById('quiz-screen');
        const endScreen = document.getElementById('end-screen');

        const startBtn = document.getElementById('start-btn');
        const restartBtn = document.getElementById('restart-btn');
        const playMelodyBtn = document.getElementById('play-melody-btn');

        const progressElem = document.getElementById('progress');
        const scoreElem = document.getElementById('score');
        const optionsContainer = document.getElementById('options-container');
        const finalScoreElem = document.getElementById('final-score');
        
        let synth, reverb;

        // --- 3. 게임 상태 변수 ---
        let currentQuestionIndex;
        let score;
        let gameQuestions = []; 
        let isMelodyPlaying = false;
        let currentPart;

        // --- 4. 게임 로직 함수 ---
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function setupAudio() {
             // 더 풍부한 소리를 내는 FMSynth 사용 및 리버브 효과 추가
            synth = new Tone.FMSynth({
                harmonicity: 3,
                modulationIndex: 10,
                detune: 0,
                oscillator: { type: "sine" },
                envelope: { attack: 0.01, decay: 0.1, sustain: 0.5, release: 1 },
                modulation: { type: "square" },
                modulationEnvelope: { attack: 0.5, decay: 0, sustain: 1, release: 0.5 }
            }).toDestination();
            
            reverb = new Tone.Reverb(1.5).toDestination();
            synth.connect(reverb);
        }

        function startGame() {
            if (!synth) {
                Tone.start();
                setupAudio();
            }

            gameQuestions = shuffleArray([...allQuizData]).slice(0, 10);
            currentQuestionIndex = 0;
            score = 0;
            
            startScreen.classList.remove('active');
            endScreen.classList.remove('active');
            quizScreen.classList.add('active');

            showQuestion();
        }

        function showQuestion() {
            if (currentPart) {
                currentPart.stop(); // 이전 파트 정지
                Tone.Transport.cancel(); // 예약된 이벤트 취소
            }
            playMelodyBtn.disabled = false;
            isMelodyPlaying = false;

            const currentQuestion = gameQuestions[currentQuestionIndex];
            
            progressElem.textContent = `문제 ${currentQuestionIndex + 1} / ${gameQuestions.length}`;
            scoreElem.textContent = `점수: ${score}`;
            
            optionsContainer.innerHTML = '';
            currentQuestion.options.forEach(option => {
                const button = document.createElement('button');
                button.textContent = option;
                button.classList.add('option-btn');
                button.addEventListener('click', () => selectAnswer(option, button));
                optionsContainer.appendChild(button);
            });
        }
        
        function playCurrentMelody() {
            if (isMelodyPlaying) return;
            isMelodyPlaying = true;
            playMelodyBtn.disabled = true;

            const currentQuestion = gameQuestions[currentQuestionIndex];
            
            // 각 곡의 BPM 설정
            Tone.Transport.bpm.value = currentQuestion.bpm || 120;

            // Tone.Part를 사용하여 정확한 타이밍에 노트 연주
            currentPart = new Tone.Part((time, value) => {
                synth.triggerAttackRelease(value.note, value.duration, time);
            }, currentQuestion.melody).start(0);

            // 멜로디 길이 계산
            const lastNote = currentQuestion.melody[currentQuestion.melody.length - 1];
            const durationInSeconds = Tone.Time(lastNote.time).toSeconds() + Tone.Time(lastNote.duration).toSeconds();

            Tone.Transport.start();
            
            // 연주가 끝나면 Transport를 멈추고 버튼 활성화
            setTimeout(() => {
                Tone.Transport.stop();
                isMelodyPlaying = false;
                if(quizScreen.classList.contains('active')){ // 퀴즈 화면일때만 버튼 활성화
                    playMelodyBtn.disabled = false;
                }
            }, (durationInSeconds + 0.5) * 1000); // 0.5초 여유
        }

        function selectAnswer(selectedOption, button) {
            // (이 부분은 이전과 동일)
            const currentQuestion = gameQuestions[currentQuestionIndex];
            const isCorrect = selectedOption === currentQuestion.answer;
            
            document.querySelectorAll('.option-btn').forEach(btn => {
                btn.disabled = true;
                if (btn.textContent === currentQuestion.answer) {
                    btn.classList.add('correct');
                }
            });

            if (isCorrect) {
                score += 10;
                scoreElem.textContent = `점수: ${score}`;
                button.classList.add('correct');
            } else {
                button.classList.add('wrong');
            }
            
            setTimeout(() => {
                currentQuestionIndex++;
                if (currentQuestionIndex < gameQuestions.length) {
                    showQuestion();
                } else {
                    showEndScreen();
                }
            }, 1500);
        }

        function showEndScreen() {
            if (currentPart) currentPart.stop();
            Tone.Transport.stop();

            quizScreen.classList.remove('active');
            endScreen.classList.add('active');
            const maxScore = gameQuestions.length * 10;
            finalScoreElem.textContent = `${score} / ${maxScore} 점`;
        }

        startBtn.addEventListener('click', startGame);
        restartBtn.addEventListener('click', () => {
             endScreen.classList.remove('active');
             startScreen.classList.add('active');
        });
        playMelodyBtn.addEventListener('click', playCurrentMelody);

    </script>
</body>
</html>

